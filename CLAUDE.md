# Инструкции для ИИ-ассистентов

> Этот файл содержит правила для Claude и других ИИ-ассистентов при работе с кодовой базой AIST Track Bot.

---

## Обязательные правила

### 1. Терминология

**ВСЕГДА используй термины из [docs/ontology.md](docs/ontology.md).**

Перед началом работы:
1. Прочитай `docs/ontology.md`
2. Используй только термины из этого документа
3. Не придумывай новые термины

При неясности:
- **Спроси пользователя**, а не придумывай сам
- Пример: "Ты имеешь в виду Урок (теория Марафона) или Дайджест (материал Ленты)?"

### 2. Краткая справка по терминам

| Термин | Что это |
|--------|---------|
| **Ученик** | Пользователь Марафона |
| **Читатель** | Пользователь Ленты |
| **Марафон** | 14-дневная программа |
| **Лента** | Гибкое обучение по дайджестам |
| **Урок** | Теория в Марафоне (материал + вопрос) |
| **Задание** | Практика в Марафоне |
| **Дайджест** | Ежедневный материал в Ленте |
| **Фиксация** | Личный вывод Читателя |
| **Сложность** | Уровень вопросов (1-3) |

### 3. Соответствие кода и терминов

При работе с кодом учитывай, что текущие имена в коде отличаются от терминологии:

| Термин | В коде сейчас | Целевое имя |
|--------|---------------|-------------|
| Урок | `theory` | `lesson` |
| Материал урока | `theory content` | `lesson_text` |
| Задание | `practice` | `task` |
| Материал задания | `practice content` | `task_text` |
| Дайджест | `feed_session`, `content` | `digest` |
| Вопрос урока | `question` | `lesson_question` |
| Вопрос пользователя | `IntentType.QUESTION` | `user_question` |
| Консультация | `handle_question` response | `consultation` |
| Фиксация | `fixation` | `fixation` |
| Сложность | `bloom_level` | `complexity` |

---

## Типы сообщений бота

### Сообщения бота

| Тип | Подтип | Описание |
|-----|--------|----------|
| **Материал** | Материал урока | Теоретический текст (Марафон) |
| **Материал** | Материал задания | Текст инструкции к практике (Марафон) |
| **Материал** | Дайджест | Ежедневный текст (Лента) |
| **Вопрос** | Вопрос урока | Проверка понимания теории |
| **Вопрос** | Бонусный вопрос | Повышенная сложность |
| **Вопрос** | Вопрос дайджеста | Для фиксации (Лента) |
| **Вопрос** | Вопрос пользователя | Вопрос в свободной форме |
| **Обратная связь** | Проверка | Комментарий к ответу |
| **Обратная связь** | Подсказка | Помощь при затруднении |
| **Обратная связь** | Консультация | Ответ на вопрос пользователя |
| **Запрос** | Запрос данных | Имя, язык и т.п. |
| **Запрос** | Меню тем | Выбор тем на неделю |
| **Сводка** | Профиль | Информация о пользователе |
| **Сводка** | Статистика | Прогресс |
| **Служебное** | Подтверждение | "Принято", "Генерирую..." |
| **Служебное** | Ошибка | Сообщение об ошибке |

### Сообщения пользователя

| Тип | Подтип | Описание |
|-----|--------|----------|
| **Вопрос** | Вопрос пользователя | Вопрос в свободной форме |
| **Ответ** | Ответ на урок | На вопрос теории |
| **Ответ** | Ответ на задание | Описание рабочего продукта |
| **Ответ** | Ответ на бонус | На бонусный вопрос |
| **Ответ** | Фиксация | Личный вывод (Лента) |

---

## Структура проекта

```
aist_bot/
├── bot.py                    # Марафон: обработчики, генерация
├── engines/
│   └── feed/                 # Лента
│       ├── engine.py         # Генерация дайджестов
│       ├── handlers.py       # Обработчики команд
│       └── planner.py        # Планирование недели
├── db/
│   ├── models.py             # Схема БД (CREATE TABLE)
│   └── queries/              # SQL-запросы
├── config/
│   └── settings.py           # Настройки, константы
├── docs/
│   ├── ontology.md           # ТЕРМИНОЛОГИЯ (источник истины)
│   ├── scenarios/            # Сценарии (пользователь ↔ бот)
│   │   ├── 01-основные/
│   │   ├── 02-вспомогательные/
│   │   └── 03-микро/
│   ├── processes/            # Процессы (внутренняя логика)
│   │   ├── process-01-activity-tracking.md
│   │   ├── process-02-content-generation.md
│   │   ├── process-03-intent-detection.md
│   │   └── process-04-stats-collection.md
│   └── data/                 # Данные (модель БД)
│       ├── tables.md         # Все таблицы и поля
│       └── metrics.md        # Метрики и их источники
├── knowledge_structure.yaml  # Структура тем Марафона
├── locales.py                # Переводы интерфейса
└── CLAUDE.md                 # Этот файл
```

---

## Три уровня документации

> Определено в `docs/ontology.md` (раздел 8).

| Категория | Описывает | Папка | Когда обновлять |
|-----------|-----------|-------|-----------------|
| **Сценарий** | Взаимодействие пользователя с ботом | `docs/scenarios/` | Изменился UI/UX |
| **Процесс** | Внутренняя логика бота | `docs/processes/` | Изменился алгоритм |
| **Данные** | Структура БД, метрики | `docs/data/` | Изменилась схема/запросы |

### Как определить категорию изменения

| Вопрос | Категория |
|--------|-----------|
| «Что увидит пользователь?» | Сценарий |
| «Как это работает внутри?» | Процесс |
| «Где это хранится?» | Данные |

---

## Правила разработки

### При изменении терминологии

1. Сначала обнови `docs/ontology.md`
2. Получи подтверждение от пользователя
3. Затем меняй код

### При добавлении нового типа сообщения

1. Определи, к какому основному типу относится (Материал, Вопрос, Обратная связь и т.д.)
2. Добавь в `docs/ontology.md`
3. Спроси пользователя, если не уверен в классификации

### При написании сообщений пользователю

- Используй русские термины из онтологии
- Пример: "Урок", не "теория" или "тема"
- Пример: "Дайджест", не "контент" или "сессия"

### При написании кода

- Используй английские эквиваленты из таблицы соответствия
- Добавляй комментарии с русскими терминами при необходимости

### При изменении README.md

**ВАЖНО:** Изменять структуру и содержание `README.md` можно **только с явного согласия пользователя**.

1. Не меняй README.md без запроса пользователя
2. Если нужно внести изменения — сначала спроси разрешения
3. Описывай предлагаемые изменения перед их внесением

### При изменении кода — ОБЯЗАТЕЛЬНО СПРОСИ

**КРИТИЧЕСКИ ВАЖНО: Любое изменение кода требует определения затронутой документации и подтверждения от пользователя.**

#### Алгоритм действий

```
1. Определи категорию изменения (Сценарий / Процесс / Данные)
2. СПРОСИ пользователя: "Это изменение затронет [категория] {ID}. Подтвердите?"
3. Дождись подтверждения
4. Внеси изменения в код
5. ОБЯЗАТЕЛЬНО обнови соответствующую документацию
6. Код + документация должны быть в одном коммите
```

#### Формат вопроса пользователю

**Для Сценария:**
> "Это изменение затронет **Сценарий 01.01 (Марафон)**. Подтвердите, что я могу продолжить?"

**Для Процесса:**
> "Это изменение затронет **Процесс P-01 (Отслеживание активности)**. Подтвердите, что я могу продолжить?"

**Для Данных:**
> "Это изменение затронет **Данные: таблица activity_log**. Подтвердите, что я могу продолжить?"

**Для нескольких категорий:**
> "Это изменение затронет:
> - Сценарий 03.01 (Прогресс)
> - Процесс P-04 (Сбор статистики)
> - Данные: таблица interns
>
> Подтвердите, что я могу продолжить?"

---

### Список сценариев

| Номер | Путь | Что затрагивает |
|-------|------|-----------------|
| 01.01 | `docs/scenarios/01-основные/scenario-01-01-marathon.md` | `/learn`, ответы на уроки/задания, прогресс Марафона |
| 01.02 | `docs/scenarios/01-основные/scenario-01-02-feed.md` | `/feed`, выбор тем, дайджесты, фиксации |
| 02.01 | `docs/scenarios/02-вспомогательные/scenario-02-01-onboarding.md` | `/start`, регистрация, FSM онбординга |
| 02.02 | `docs/scenarios/02-вспомогательные/scenario-02-02-mode-switch.md` | `/mode`, переключение режимов |
| 02.03 | `docs/scenarios/02-вспомогательные/scenario-02-03-profile-update.md` | `/update`, редактирование профиля |
| 02.04 | `docs/scenarios/02-вспомогательные/scenario-02-04-consultation.md` | Вопросы пользователя, MCP, qa_history |
| 02.05 | `docs/scenarios/02-вспомогательные/scenario-02-05-reminders.md` | Напоминания, scheduler, таблица reminders |
| 03.01 | `docs/scenarios/03-микро/scenario-03-01-progress.md` | `/progress`, статистика |
| 03.02 | `docs/scenarios/03-микро/scenario-03-02-profile.md` | `/profile`, отображение профиля |
| 03.03 | `docs/scenarios/03-микро/scenario-03-03-language.md` | `/language`, смена языка |
| 03.04 | `docs/scenarios/03-микро/scenario-03-04-bonus.md` | Бонусные вопросы |
| 03.05 | `docs/scenarios/03-микро/scenario-03-05-skip.md` | `/skip`, пропуск тем |

### Список процессов

| ID | Путь | Что затрагивает |
|----|------|-----------------|
| P-01 | `docs/processes/process-01-activity-tracking.md` | `record_active_day()`, streak, `activity_log` |
| P-02 | `docs/processes/process-02-content-generation.md` | Claude API, MCP, генерация уроков/дайджестов |
| P-03 | `docs/processes/process-03-intent-detection.md` | `detect_intent()`, IntentType |
| P-04 | `docs/processes/process-04-stats-collection.md` | `/progress`, агрегация статистики |

### Данные (таблицы)

| Таблица | Документация | Что затрагивает |
|---------|--------------|-----------------|
| `interns` | `docs/data/tables.md` | Профиль, режимы, streak |
| `answers` | `docs/data/tables.md` | Ответы на уроки/задания, фиксации |
| `activity_log` | `docs/data/tables.md` | Лог активности, streak |
| `feed_weeks` | `docs/data/tables.md` | Недели Ленты |
| `feed_sessions` | `docs/data/tables.md` | Дайджесты |
| `reminders` | `docs/data/tables.md` | Напоминания |
| `qa_history` | `docs/data/tables.md` | Вопросы пользователей |

### Что обновлять

#### В Сценарии:
- Последовательность сообщений
- FSM состояния
- Callbacks/кнопки
- Ключевые файлы (номера строк)

#### В Процессе:
- Алгоритм/диаграмма
- Входные/выходные данные
- Вызовы функций
- Связи с другими процессами

#### В Данных:
- Поля таблиц
- Типы данных
- Ограничения (UNIQUE, FK)
- Метрики и их формулы

---

## Частые ошибки

| Неправильно | Правильно |
|-------------|-----------|
| "контент" (в Ленте) | Дайджест |
| "тема" (как единица обучения) | Урок / Задание / Дайджест |
| "сессия" | Дайджест (Лента) или День (Марафон) |
| "вопрос для размышления" | Вопрос урока / Вопрос дайджеста |
| "рефлексия" | Фиксация |
| "уровень Блума" | Сложность |
| "пользователь" (когда известен режим) | Ученик (Марафон) / Читатель (Лента) |

---

## Чеклист перед коммитом

### Терминология
- [ ] Термины соответствуют `docs/ontology.md`
- [ ] Новые сущности добавлены в онтологию
- [ ] Сообщения пользователю используют русские термины
- [ ] Код использует согласованные английские имена

### Документация (Сценарии / Процессы / Данные)
- [ ] **Пользователь подтвердил изменения**
- [ ] Затронутые **Сценарии** обновлены (`docs/scenarios/`)
- [ ] Затронутые **Процессы** обновлены (`docs/processes/`)
- [ ] Затронутые **Данные** обновлены (`docs/data/`)
- [ ] Код + документация в одном коммите

### Автоматические проверки
- [ ] `tests/test-repo/requirements-scenarios.yaml` актуален
- [ ] `tests/test-repo/requirements-processes.yaml` актуален
- [ ] `tests/test-repo/requirements-data.yaml` актуален
