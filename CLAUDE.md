# Инструкции для ИИ-ассистентов

> Этот файл содержит правила для Claude и других ИИ-ассистентов при работе с кодовой базой AIST Track Bot.

---

## Обязательные правила

### 1. Терминология

**ВСЕГДА используй термины из [docs/ontology.md](docs/ontology.md).**

Перед началом работы:
1. Прочитай `docs/ontology.md`
2. Используй только термины из этого документа
3. Не придумывай новые термины

При неясности:
- **Спроси пользователя**, а не придумывай сам
- Пример: "Ты имеешь в виду Урок (теория Марафона) или Дайджест (материал Ленты)?"

### 2. Краткая справка по терминам

| Термин | Что это |
|--------|---------|
| **Ученик** | Пользователь Марафона |
| **Читатель** | Пользователь Ленты |
| **Марафон** | 14-дневная программа |
| **Лента** | Гибкое обучение по дайджестам |
| **Урок** | Теория в Марафоне (материал + вопрос) |
| **Задание** | Практика в Марафоне |
| **Дайджест** | Ежедневный материал в Ленте |
| **Фиксация** | Личный вывод Читателя |
| **Сложность** | Уровень вопросов (1-3) |

### 3. Соответствие кода и терминов

При работе с кодом учитывай, что текущие имена в коде отличаются от терминологии:

| Термин | В коде сейчас | Целевое имя |
|--------|---------------|-------------|
| Урок | `theory` | `lesson` |
| Материал урока | `theory content` | `lesson_text` |
| Задание | `practice` | `task` |
| Материал задания | `practice content` | `task_text` |
| Дайджест | `feed_session`, `content` | `digest` |
| Вопрос урока | `question` | `lesson_question` |
| Вопрос пользователя | `IntentType.QUESTION` | `user_question` |
| Консультация | `handle_question` response | `consultation` |
| Фиксация | `fixation` | `fixation` |
| Сложность | `bloom_level` | `complexity` |

---

## Типы сообщений бота

### Сообщения бота

| Тип | Подтип | Описание |
|-----|--------|----------|
| **Материал** | Материал урока | Теоретический текст (Марафон) |
| **Материал** | Материал задания | Текст инструкции к практике (Марафон) |
| **Материал** | Дайджест | Ежедневный текст (Лента) |
| **Вопрос** | Вопрос урока | Проверка понимания теории |
| **Вопрос** | Бонусный вопрос | Повышенная сложность |
| **Вопрос** | Вопрос дайджеста | Для фиксации (Лента) |
| **Вопрос** | Вопрос пользователя | Вопрос в свободной форме |
| **Обратная связь** | Проверка | Комментарий к ответу |
| **Обратная связь** | Подсказка | Помощь при затруднении |
| **Обратная связь** | Консультация | Ответ на вопрос пользователя |
| **Запрос** | Запрос данных | Имя, язык и т.п. |
| **Запрос** | Меню тем | Выбор тем на неделю |
| **Сводка** | Профиль | Информация о пользователе |
| **Сводка** | Статистика | Прогресс |
| **Служебное** | Подтверждение | "Принято", "Генерирую..." |
| **Служебное** | Ошибка | Сообщение об ошибке |

### Сообщения пользователя

| Тип | Подтип | Описание |
|-----|--------|----------|
| **Вопрос** | Вопрос пользователя | Вопрос в свободной форме |
| **Ответ** | Ответ на урок | На вопрос теории |
| **Ответ** | Ответ на задание | Описание рабочего продукта |
| **Ответ** | Ответ на бонус | На бонусный вопрос |
| **Ответ** | Фиксация | Личный вывод (Лента) |

---

## Структура проекта

```
aist_track_bot/
├── bot.py                    # Марафон: обработчики, генерация
├── engines/
│   └── feed/                 # Лента
│       ├── engine.py         # Генерация дайджестов
│       ├── handlers.py       # Обработчики команд
│       └── planner.py        # Планирование недели
├── db/
│   ├── models.py             # SQLAlchemy модели
│   └── queries/              # SQL-запросы
├── config/
│   └── settings.py           # Настройки, константы
├── docs/
│   ├── ontology.md           # ТЕРМИНОЛОГИЯ (источник истины)
│   └── scenarios/            # Сценарии работы бота
│       ├── 01-основные/      # Основные сценарии (Марафон, Лента)
│       ├── 02-вспомогательные/  # Вспомогательные (онбординг, режимы и др.)
│       ├── 03-микро/         # Микро-сценарии (прогресс, профиль и др.)
│       └── 04-технические/   # Технические (генерация, интент и др.)
├── knowledge_structure.yaml  # Структура тем Марафона
├── locales.py                # Переводы интерфейса
└── CLAUDE.md                 # Этот файл
```

---

## Правила разработки

### При изменении терминологии

1. Сначала обнови `docs/ontology.md`
2. Получи подтверждение от пользователя
3. Затем меняй код

### При добавлении нового типа сообщения

1. Определи, к какому основному типу относится (Материал, Вопрос, Обратная связь и т.д.)
2. Добавь в `docs/ontology.md`
3. Спроси пользователя, если не уверен в классификации

### При написании сообщений пользователю

- Используй русские термины из онтологии
- Пример: "Урок", не "теория" или "тема"
- Пример: "Дайджест", не "контент" или "сессия"

### При написании кода

- Используй английские эквиваленты из таблицы соответствия
- Добавляй комментарии с русскими терминами при необходимости

### При изменении README.md

**ВАЖНО:** Изменять структуру и содержание `README.md` можно **только с явного согласия пользователя**.

1. Не меняй README.md без запроса пользователя
2. Если нужно внести изменения — сначала спроси разрешения
3. Описывай предлагаемые изменения перед их внесением

### При изменении кода, затрагивающего сценарии

**ВАЖНО: Изменение кода требует синхронизации со сценариями.**

1. **Перед изменением кода:**
   - Определи, какой сценарий затрагивается (см. список ниже)
   - **Спроси пользователя:** "Это изменение затронет сценарий {XX.NN}. Подтвердите, что я могу продолжить?"
   - Дождись подтверждения

2. **После изменения кода:**
   - **Обязательно** обнови соответствующий файл `docs/scenario-*.md`
   - Изменения в коде и сценарии должны быть в одном коммите

### Список сценариев

| Номер | Путь | Что затрагивает |
|-------|------|-----------------|
| 01.01 | `docs/scenarios/01-основные/scenario-01-01-marathon.md` | `/learn`, ответы на уроки/задания, прогресс Марафона |
| 01.02 | `docs/scenarios/01-основные/scenario-01-02-feed.md` | `/feed`, выбор тем, дайджесты, фиксации |
| 02.01 | `docs/scenarios/02-вспомогательные/scenario-02-01-onboarding.md` | `/start`, регистрация, FSM онбординга |
| 02.02 | `docs/scenarios/02-вспомогательные/scenario-02-02-mode-switch.md` | `/mode`, переключение режимов |
| 02.03 | `docs/scenarios/02-вспомогательные/scenario-02-03-profile-update.md` | `/update`, редактирование профиля |
| 02.04 | `docs/scenarios/02-вспомогательные/scenario-02-04-consultation.md` | Вопросы пользователя, MCP, qa_history |
| 02.05 | `docs/scenarios/02-вспомогательные/scenario-02-05-reminders.md` | Напоминания, scheduler, таблица reminders |
| 03.01 | `docs/scenarios/03-микро/scenario-03-01-progress.md` | `/progress`, статистика |
| 03.02 | `docs/scenarios/03-микро/scenario-03-02-profile.md` | `/profile`, отображение профиля |
| 03.03 | `docs/scenarios/03-микро/scenario-03-03-language.md` | `/language`, смена языка |
| 03.04 | `docs/scenarios/03-микро/scenario-03-04-bonus.md` | Бонусные вопросы |
| 03.05 | `docs/scenarios/03-микро/scenario-03-05-skip.md` | `/skip`, пропуск тем |
| 04.01 | `docs/scenarios/04-технические/scenario-04-01-content-generation.md` | Генерация контента, Claude API, MCP |
| 04.02 | `docs/scenarios/04-технические/scenario-04-02-intent-detection.md` | Определение интента |
| 04.03 | `docs/scenarios/04-технические/scenario-04-03-activity-tracking.md` | activity_log, streaks |

### Что обновлять в сценарии

При изменении кода обнови в сценарии:
- **Последовательность сообщений** — если изменился поток
- **Сохраняемые данные** — если изменились поля БД или SQL-запросы
- **FSM состояния** — если добавились/изменились состояния
- **Callbacks** — если изменились кнопки
- **Ключевые файлы** — если изменились номера строк

---

## Частые ошибки

| Неправильно | Правильно |
|-------------|-----------|
| "контент" (в Ленте) | Дайджест |
| "тема" (как единица обучения) | Урок / Задание / Дайджест |
| "сессия" | Дайджест (Лента) или День (Марафон) |
| "вопрос для размышления" | Вопрос урока / Вопрос дайджеста |
| "рефлексия" | Фиксация |
| "уровень Блума" | Сложность |
| "пользователь" (когда известен режим) | Ученик (Марафон) / Читатель (Лента) |

---

## Чеклист перед коммитом

- [ ] Термины соответствуют `docs/ontology.md`
- [ ] Новые сущности добавлены в онтологию
- [ ] Сообщения пользователю используют русские термины
- [ ] Код использует согласованные английские имена
- [ ] **Затронутые сценарии обновлены** (`docs/scenario-*.md`)
- [ ] Сохраняемые данные описаны в сценарии
