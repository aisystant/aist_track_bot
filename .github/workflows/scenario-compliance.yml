name: Scenario Compliance Check

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 06:00 MSK (03:00 UTC)
    - cron: '0 3 * * *'
  workflow_dispatch:
    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub

jobs:
  check-scenarios:
    name: Check Code vs Scenarios
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Run scenario compliance check
        id: check
        run: |
          python -m tests.test_repo.scripts.checker --json > result.json
          cat result.json

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
          COVERAGE=$(jq -r '.coverage' result.json)
          STATUS=$(jq -r '.status' result.json)
          REPORT_PATH=$(jq -r '.report_path' result.json)

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "report_path=$REPORT_PATH" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate report file
        run: |
          python -m tests.test_repo.scripts.checker

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: scenario-compliance-report
          path: tests/test_repo/reports/*.md
          retention-days: 90

      - name: Commit report to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add tests/test_repo/reports/*.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "chore: add scenario compliance report for $DATE"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          COVERAGE=${{ steps.check.outputs.coverage }}
          STATUS=${{ steps.check.outputs.status }}

          if [ "$STATUS" = "green" ]; then
            EMOJI="üü¢"
            MESSAGE="–ö–æ–¥ —Ö–æ—Ä–æ—à–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è–º"
          elif [ "$STATUS" = "yellow" ]; then
            EMOJI="üü°"
            MESSAGE="–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã"
          else
            EMOJI="üî¥"
            MESSAGE="–ö—Ä–∏—Ç–∏—á–Ω–æ: –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π"
          fi

          echo "## $EMOJI –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è–º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ü–æ–∫—Ä—ã—Ç–∏–µ:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$MESSAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö." >> $GITHUB_STEP_SUMMARY

      - name: Fail if coverage is critical
        if: steps.check.outputs.status == 'red'
        run: |
          echo "‚ùå –ü–æ–∫—Ä—ã—Ç–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–æ–µ: ${{ steps.check.outputs.coverage }}%"
          exit 1
