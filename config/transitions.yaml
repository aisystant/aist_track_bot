# ============================================
# ТАБЛИЦА ПЕРЕХОДОВ STATE MACHINE
# ============================================
# Формат:
#   state_name:
#     description: "Описание стейта"
#     events:
#       event_name: next_state_name
#     allow_global: [list of global events]
#
# Специальные значения next_state:
#   _previous - вернуться в предыдущий стейт
#   _same - остаться в текущем стейте
# ============================================

states:

  # ==========================================
  # ОБЩИЕ СТЕЙТЫ (common.*)
  # ==========================================

  common.start:
    description: "Начало работы, онбординг нового пользователя"
    events:
      new_user: common.start           # Продолжаем онбординг
      onboarding_complete: common.mode_select
      existing_user: common.mode_select
      error: common.error

  common.error:
    description: "Обработка ошибок"
    events:
      retry: common.start
      continue: _previous

  common.mode_select:
    description: "Выбор режима работы"
    events:
      marathon: workshop.marathon.lesson
      feed: feed.topics
      exocortex: workshop.exocortex.audit
      fpfkids: workshop.fpfkids.goals
      practice: workshop.practice.topic_select
      settings: common.settings
    allow_global: [consultation, notes]

  common.settings:
    description: "Настройки пользователя"
    events:
      saved: common.mode_select
      cancel: _previous

  common.consultation:
    description: "Консультация (ответ на вопрос пользователя)"
    events:
      answered: _previous               # Возврат в предыдущий стейт
      followup: _same                   # Уточняющий вопрос
      done: _previous

  # ==========================================
  # МАСТЕРСКАЯ: МАРАФОН (workshop.marathon.*)
  # ==========================================

  workshop.marathon.lesson:
    description: "Показ урока текущего дня"
    events:
      lesson_shown: workshop.marathon.question
      already_completed: workshop.marathon.task
      marathon_complete: common.mode_select
    allow_global: [consultation, notes]

  workshop.marathon.question:
    description: "Вопрос на понимание урока"
    events:
      correct: workshop.marathon.bonus  # Уровни 2-3 → предлагаем бонусный вопрос
      correct_level_1: workshop.marathon.task  # Уровень 1 → сразу задание
      incorrect: _same                  # Повторяем вопрос
      skip: workshop.marathon.task
      hint: _same                       # Показываем подсказку
    allow_global: [consultation, notes]

  workshop.marathon.bonus:
    description: "Бонусный вопрос повышенной сложности"
    events:
      yes: _same                        # Отвечаем на бонусный вопрос
      answered: workshop.marathon.task  # Ответ принят → задание
      no: workshop.marathon.task        # Отказ → сразу к заданию
    allow_global: [consultation, notes]

  workshop.marathon.task:
    description: "Практическое задание"
    events:
      submitted: workshop.marathon.lesson  # Следующий урок
      feedback_requested: _same
      day_complete: workshop.marathon.lesson
    allow_global: [consultation, notes]

  # ==========================================
  # ЛЕНТА (feed.*)
  # ==========================================

  feed.topics:
    description: "Выбор тем для Ленты"
    events:
      topics_selected: feed.digest
      skip: common.mode_select
    allow_global: [consultation, notes]

  feed.digest:
    description: "Показ дайджеста"
    events:
      digest_shown: _same               # Ждём фиксацию
      fixation_saved: _same             # Следующий дайджест
      change_topics: feed.topics
      done: common.mode_select
    allow_global: [consultation, notes]

  # ==========================================
  # УТИЛИТЫ (utility.*)
  # ==========================================

  utility.notes:
    description: "Заметочник"
    events:
      saved: _previous
      list_shown: _same
      error: _previous

  utility.export:
    description: "Экспорт данных"
    events:
      exported: _previous
      error: _previous


# ==========================================
# ГЛОБАЛЬНЫЕ СОБЫТИЯ
# ==========================================
# Эти события можно вызвать из любого стейта,
# если он указан в allow_global

global_events:
  consultation:
    trigger: "?"                        # Сообщение начинается с ?
    target: common.consultation

  notes:
    trigger: "/note"                    # Команда /note
    target: utility.notes

  export:
    trigger: "/export"
    target: utility.export

  help:
    trigger: "/help"
    target: common.help

  mode:
    trigger: "/mode"
    target: common.mode_select
