# 04.02 Определение интента

> Технический сценарий распознавания типа сообщения пользователя.

---

## Обзор

| Параметр | Значение |
|----------|----------|
| Тип | Технический сценарий |
| Файл | `core/intent.py` |
| Типов интентов | 6 |

---

## 1. Типы интентов

| Тип | Код | Описание |
|-----|-----|----------|
| **QUESTION** | `question` | Вопрос пользователя |
| **ANSWER** | `answer` | Ответ на урок/задание |
| **TOPIC_REQUEST** | `topic_request` | Запрос следующей темы |
| **COMMAND** | `command` | Встроенная команда |
| **FEEDBACK** | `feedback` | Короткий комментарий |
| **UNKNOWN** | `unknown` | Не распознано |

---

## 2. Приоритет проверок

```
1. COMMAND        ████████████ Высший приоритет
    ↓
2. ANSWER         ████████████ (если ждём ответ)
    ↓  └→ QUESTION (если явный вопрос)
3. TOPIC_REQUEST  ████████
    ↓
4. QUESTION       ████████ (вероятностный)
    ↓
5. FEEDBACK       ████ (короткое сообщение)
    ↓
6. ANSWER         ████ (контекст + длинный текст)
    ↓
7. UNKNOWN        ██
```

---

## 3. Распознавание вопроса

### Явный вопрос (is_clear_question)

**Критерии:**

| Признак | Пример |
|---------|--------|
| Вопросительный знак в конце | "Это работает?" |
| Начало с вопросительного слова | "Как это работает?" |
| Вопросительные конструкции | "можно ли", "объясни", "расскажи" |

**Вопросительные слова:**
- RU: что, как, почему, когда, где, кто, зачем, какой
- EN: what, how, why, when, where, who, which
- ES: qué, cómo, por qué, cuándo, dónde, quién

### Вероятностная оценка (question_likelihood)

| Признак | Баллы |
|---------|-------|
| Вопросительный знак `?` | +0.5 |
| Вопросительное слово в начале | +0.3 |
| Вопросительное слово внутри | +0.1 |
| Фразы "что такое", "как это" | +0.3 |
| Длинный текст без признаков | ×0.5 |

**Порог:** score ≥ 0.7 → QUESTION

**Примеры:**
```
"Что это?"                    → 0.5 + 0.3 = 0.8 ✅
"Можешь объяснить?"           → 0.5 + 0.3 = 0.8 ✅
"Я не понимаю это"            → 0.0 ❌ (ниже порога)
```

---

## 4. Распознавание запроса темы

### Паттерны (регулярные выражения)

```
дай\s+тему           → "дай тему"
давай\s+тему         → "давай тему"
следующ\w+\s+тем     → "следующая тема"
хочу\s+учиться       → "хочу учиться"
хочу\s+изучать       → "хочу изучать"
начать\s+марафон     → "начать марафон"
продолжить\s+ленту   → "продолжить ленту"
```

**Confidence:** 0.9

---

## 5. Распознавание команд

### Встроенные команды

| RU | EN | ES | Действие |
|----|----|----|----------|
| проще | simpler | más simple | Упростить |
| глубже | deeper | más profundo | Углубить |
| примеры | examples | ejemplos | Больше примеров |
| дальше | next | siguiente | Далее |
| пропустить | skip | saltar | Пропустить |

**Confidence:** 1.0

---

## 6. Влияние контекста

### Параметры контекста

| Ключ | Эффект |
|------|--------|
| `awaiting_answer` | Текст → ANSWER (кроме явных вопросов) |
| `awaiting_work_product` | Текст → ANSWER |
| `mode` | Различие FEEDBACK vs ANSWER |

### Примеры

| Текст | Контекст | Результат |
|-------|----------|-----------|
| "Это не работает?" | `awaiting_answer=True` | QUESTION |
| "Я сделал это так" | `awaiting_answer=True` | ANSWER |
| "Спасибо!" | `mode=None` | FEEDBACK |
| "Мне было полезно" | `mode="marathon"` | ANSWER |

---

## 7. Извлечение ключевых слов

### Функция get_question_keywords()

Для поиска в MCP:
1. Удаляет стоп-слова
2. Убирает короткие слова (<3 символов)
3. Максимум 5 слов

**Пример:**
```
"Почему важно использовать системный подход?"
→ ["использовать", "системный", "подход"]
```

---

## 8. Структура результата

```python
class Intent:
    type: IntentType          # QUESTION, ANSWER, ...
    confidence: float         # 0.0 - 1.0
    command: Optional[str]    # Для COMMAND
    original_text: str        # Исходный текст
```

---

## 9. Использование в коде

```python
# bot.py
intent = detect_intent(text, context={'mode': intern.get('mode')})

if intent.type == IntentType.QUESTION:
    # Обработка через MCP
    answer, sources = await handle_question(...)
elif intent.type == IntentType.TOPIC_REQUEST:
    # Отправка следующей темы
    await send_topic(...)
```

---

## 10. Диаграмма

```
Сообщение пользователя
    ↓
detect_intent(text, context)
    ↓
┌─ Команда? (проще, глубже...)
│  └→ COMMAND (confidence=1.0)
│
├─ Ждём ответ?
│  ├─ Явный вопрос? → QUESTION
│  └─ Иначе → ANSWER
│
├─ Запрос темы? (дай тему, следующая...)
│  └→ TOPIC_REQUEST (confidence=0.9)
│
├─ Вероятность вопроса ≥ 0.7?
│  └→ QUESTION
│
├─ Короткое сообщение без контекста?
│  └→ FEEDBACK (confidence=0.6)
│
├─ Контекст + длинный текст?
│  └→ ANSWER (confidence=0.7)
│
└─ Иначе → UNKNOWN
```

---

## 11. Ключевые файлы

| Файл | Назначение |
|------|-----------|
| `core/intent.py` | Вся логика определения |
| `config/settings.py` | QUESTION_WORDS, COMMAND_WORDS |
| `bot.py` | Использование в обработчиках |

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-22 | Создание документа |
