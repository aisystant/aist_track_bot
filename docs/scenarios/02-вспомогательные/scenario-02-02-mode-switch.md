# 02.02 Сценарий переключения режимов

> Полное описание процесса переключения между режимами Марафон и Лента.

---

## Обзор

| Параметр | Значение |
|----------|----------|
| Команда | `/mode` |
| Режимы | Марафон, Лента |
| Файл логики | `engines/mode_selector.py` |

---

## 1. Режимы и статусы

### Режимы работы

| Режим | Код | Описание |
|-------|-----|----------|
| **Марафон** | `marathon` | 14-дневная программа |
| **Лента** | `feed` | Гибкое обучение по дайджестам |

### Статусы Марафона

| Статус | Описание |
|--------|----------|
| `not_started` | Начальное состояние |
| `active` | Идёт обучение |
| `paused` | На паузе (активирована Лента) |
| `completed` | Марафон завершён |

### Статусы Ленты

| Статус | Описание |
|--------|----------|
| `not_started` | Начальное состояние |
| `active` | Активный режим |
| `paused` | На паузе (активирован Марафон) |

---

## 2. Главное меню /mode

### Сообщение бота

```
🎯 *Выберите режим обучения*

*Текущий режим:* Марафон

━━━━━━━━━━━━━━━━━━

📚 *Марафон* — 14-дневный курс
✅ Активен (День 5 из 14)
_Каждый день изучаете две темы: теория + практика_

━━━━━━━━━━━━━━━━━━

🌊 *Лента* — бесконечный режим
⏸ На паузе
_ИИ предлагает темы, вы выбираете что изучать_

[📚 Марафон] [🌊 Лента]
```

### Иконки статусов

| Статус | Иконка |
|--------|--------|
| active | ✅ Активен |
| paused | ⏸ На паузе |
| not_started | ⚪ Не начат |
| completed | 🏆 Завершён |

---

## 3. Матрица переключений

### Переключение НА МАРАФОН

| Из состояния | В состояние | Эффект |
|--------------|-------------|--------|
| Лента `active` | Марафон `active` | Лента → `paused` |
| Лента `paused` | Марафон `active` | — |
| Лента `not_started` | Марафон `active` | — |
| Марафон `completed` | Марафон `completed` | Без изменений |
| Марафон `active` | Марафон `active` | Без изменений |

### Переключение НА ЛЕНТУ

| Из состояния | В состояние | Эффект |
|--------------|-------------|--------|
| Марафон `active` | Лента `active` | Марафон → `paused` |
| Марафон `not_started` + прогресс | Лента `active` | Марафон → `paused` |
| Марафон `paused` | Лента `active` | — |
| Марафон `not_started` без прогресса | Лента `active` | — |
| Марафон `completed` | Лента `active` | — |
| Лента `active` | Лента `active` | Без изменений |

---

## 4. Последовательность сообщений

### Активация Марафона

```
[Пользователь]                        [Бот]

Кнопка "📚 Марафон" ─────────────────► Проверка текущего статуса
                                      ↓
                                      [Если Лента была active]
                                      UPDATE feed_status = 'paused'
                                      ↓
                                      UPDATE mode = 'marathon'
                                      UPDATE marathon_status = 'active'
                                      ↓
                                      Сводка: Статистика
                                      "✅ *Режим Марафон активирован!*"

                                      "День 5 из 14 | 8/28 тем"

                                      "*Ваши настройки:*"
                                      "⏰ Время: 09:00"
                                      "📖 На чтение: 15 мин"
                                      "📊 Сложность: Понимание"

                                      "_Лента на паузе. Вернуться: /mode_"

                                      [📝 Обновить данные]
                                      [⏰ Напоминания]
                                      [🔄 Сбросить марафон]
```

### Активация Ленты

```
[Пользователь]                        [Бот]

Кнопка "🌊 Лента" ───────────────────► Проверка текущего статуса
                                      ↓
                                      [Если Марафон был active или есть прогресс]
                                      UPDATE marathon_status = 'paused'
                                      ↓
                                      UPDATE mode = 'feed'
                                      UPDATE feed_status = 'active'
                                      ↓
                                      Сводка: Статистика
                                      "✅ *Режим Лента активирован!*"

                                      "*Ваши настройки:*"
                                      "⏰ Время: 09:00"
                                      "📖 На чтение: 15 мин"

                                      [Если есть активная неделя]
                                      "*Ваши темы:*"
                                      "1. Собранность"
                                      "2. Фокус"

                                      "_Марафон на паузе. Вернуться: /mode_"

                                      [📖 Получить дайджест] или [📚 Выбрать темы]
                                      [📝 Обновить данные]
                                      [⏰ Напоминания]
```

---

## 5. Сохраняемые данные

### Что сохраняется при паузе Марафона

| Поле | Описание |
|------|----------|
| `marathon_status` | → `paused` |
| `current_topic_index` | Текущая позиция |
| `completed_topics` | Список пройденных тем |
| `marathon_start_date` | Дата начала |
| `topics_today` | Счётчик дневных тем |
| `complexity_level` | Уровень сложности |

### Что сохраняется при паузе Ленты

| Поле | Описание |
|------|----------|
| `feed_status` | → `paused` |
| `feed_started_at` | Дата начала Ленты |
| `active_days_total` | Количество активных дней |
| `active_days_streak` | Текущая серия |
| `longest_streak` | Рекорд |

### Что НЕ теряется при переключении

- Профиль пользователя (имя, интересы, цели)
- Все ответы и рабочие продукты (таблица `answers`)
- История активности (таблица `activity_log`)
- Статистика Ленты (таблица `feed_weeks`)
- История вопросов (таблица `qa_history`)

---

## 6. Дополнительные действия

### Обновление данных

Кнопка ведёт в `/update` с отображением текущего профиля.

### Настройка напоминаний

```
Пользователь → Кнопка "⏰ Напоминания"

Бот → "Введите время напоминания (ЧЧ:ММ)"
      "Можно указать до 2 времён через запятую"
      "Например: 09:00, 21:00"
```

### Настройка сложности

```
Пользователь → Кнопка "📊 Сложность"

Бот → "Выберите уровень сложности:"

      [1️⃣ Базовый — понимание основ]
      [2️⃣ Средний — применение на практике]
      [3️⃣ Продвинутый — анализ и синтез]
```

### Сброс Марафона

```
Пользователь → Кнопка "🔄 Сбросить марафон"

Бот → "⚠️ *Внимание!*"
      "Это сбросит весь прогресс Марафона."
      "_Статистика Ленты сохранится._"

      [Да, сбросить] [Отмена]

Пользователь → "Да, сбросить"

Бот → UPDATE completed_topics = []
      UPDATE current_topic_index = 0
      UPDATE marathon_start_date = today
      UPDATE marathon_status = 'active'
      UPDATE topics_today = 0

      "✅ Марафон сброшен. День 1 из 14."
```

---

## 7. Поля БД

### Таблица `interns`

| Поле | Тип | Описание |
|------|-----|----------|
| `mode` | TEXT | Текущий режим (`marathon` / `feed`) |
| `marathon_status` | TEXT | Статус марафона |
| `feed_status` | TEXT | Статус ленты |
| `marathon_start_date` | DATE | Дата старта марафона |
| `completed_topics` | JSON | Пройденные темы |
| `current_topic_index` | INTEGER | Позиция в марафоне |
| `complexity_level` | INTEGER | Уровень сложности (1-3) |
| `schedule_time` | TEXT | Время напоминания |

---

## 8. Диаграмма переходов

```
                    ┌─────────────────┐
                    │    /mode        │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              ↓                             ↓
    ┌─────────────────┐           ┌─────────────────┐
    │  📚 Марафон     │           │  🌊 Лента       │
    └────────┬────────┘           └────────┬────────┘
             │                             │
             ↓                             ↓
    ┌─────────────────┐           ┌─────────────────┐
    │ Лента active?   │           │ Марафон active? │
    │ или с прогрессом│           │ или с прогрессом│
    └────────┬────────┘           └────────┬────────┘
            ↙ ↘                           ↙ ↘
          Да   Нет                      Да   Нет
          ↓     ↓                       ↓     ↓
    ┌──────┐ ┌──────┐            ┌──────┐ ┌──────┐
    │Лента │ │      │            │Мар-н │ │      │
    │paused│ │      │            │paused│ │      │
    └──────┘ └──────┘            └──────┘ └──────┘
          ↓     ↓                       ↓     ↓
          └──┬──┘                       └──┬──┘
             ↓                             ↓
    ┌─────────────────┐           ┌─────────────────┐
    │ Марафон active  │           │ Лента active    │
    │ mode = marathon │           │ mode = feed     │
    └─────────────────┘           └─────────────────┘
```

---

## 9. Ключевые файлы

| Файл | Назначение |
|------|-----------|
| `engines/mode_selector.py` | Вся логика переключения |
| `config/settings.py` | Mode, MarathonStatus, FeedStatus |
| `db/models.py` | Структура таблицы interns |
| `db/queries/users.py` | get_intern, update_intern |
| `engines/feed/engine.py` | FeedEngine |

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-22 | Создание документа |
