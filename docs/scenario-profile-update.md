# Сценарий обновления профиля

> Полное описание процесса редактирования данных пользователя.

---

## Обзор

| Параметр | Значение |
|----------|----------|
| Команда | `/update` |
| Доступ | После завершения онбординга |
| Количество полей | 10 |

---

## 1. Главное меню /update

### Сообщение бота

```
👤 *Иван*
💼 Разработчик
🎨 гольф, чтение, путешествия

💫 Хочу быть лучше...
🎯 Развить навыки...

⚡ 15 минут на тему
📊 Понимание (уровень 2)
🗓 01.01.2026 (День 5 из 14)
⏰ 09:00
🌐 Русский

*Что хотите изменить?*

[👤 Имя]        [💼 Занятие]
[🎨 Интересы]   [🎯 Цели]
[⏱ Время]       [⏰ Расписание]
[📊 Сложность]  [🤖 Режим бота]
[🌐 Language]
[❌ Отмена]
```

---

## 2. Редактируемые поля

### Таблица полей

| Поле | Callback | Тип ввода | Валидация |
|------|----------|-----------|-----------|
| Имя | `upd_name` | Текст | `.strip()` |
| Занятие | `upd_occupation` | Текст | `.strip()` |
| Интересы | `upd_interests` | Текст | Парсинг `,;` |
| Мотивация | `upd_motivation` | Текст | `.strip()` |
| Цели | `upd_goals` | Текст | `.strip()` |
| Время на тему | `upd_duration` | Кнопки | 5, 15, 25 |
| Расписание | `upd_schedule` | Текст | ЧЧ:ММ |
| Сложность | `upd_bloom` | Кнопки | 1, 2, 3 |
| Режим бота | `upd_mode` | Переход | → `/mode` |
| Дата старта | `upd_marathon_start` | Кнопки | Сегодня/+1/+2 |
| Язык | `upd_language` | Кнопки | ru, en, es |

---

## 3. Последовательность для каждого поля

### Текстовые поля (Имя, Занятие, Цели, Мотивация)

```
[Пользователь]                        [Бот]

Кнопка "👤 Имя" ─────────────────────► FSM: updating_name

                                      "👤 *Ваше имя:* Иван"
                                      "Как вас зовут?"

"Александр" ─────────────────────────► UPDATE name = 'Александр'

                                      "✅ Имя изменено!"

                                      "/learn — продолжить обучение"
                                      "/update — обновить ещё что-то"

                                      FSM: cleared
```

### Интересы (с парсингом)

```
[Пользователь]                        [Бот]

Кнопка "🎨 Интересы" ────────────────► FSM: updating_interests

                                      "🎨 *Ваши интересы:* гольф, чтение"
                                      "Какие у вас интересы?"
                                      "_Через запятую_"

"музыка, спорт, книги" ──────────────► Парсинг: ["музыка", "спорт", "книги"]
                                      UPDATE interests = '["музыка", "спорт", "книги"]'

                                      "✅ Интересы обновлены!"
```

### Время на тему (кнопки)

```
[Пользователь]                        [Бот]

Кнопка "⏱ Время" ────────────────────► FSM: updating_duration

                                      "⏱ *Сейчас:* 15 минут"
                                      "Сколько минут на одну тему?"

                                      [⚡ 5 мин] [🕑 15 мин] [🕓 25 мин]

Кнопка "⚡ 5 мин" ────────────────────► UPDATE study_duration = 5

                                      "✅ Время изменено на 5 минут!"
```

### Расписание (с валидацией)

```
[Пользователь]                        [Бот]

Кнопка "⏰ Расписание" ──────────────► FSM: updating_schedule

                                      "⏰ *Сейчас:* 09:00"
                                      "Во сколько напоминать?"
                                      "_Формат: ЧЧ:ММ_"

"25:70" ─────────────────────────────► Ошибка валидации
                                      "Попробуй ещё раз (ЧЧ:ММ)"
                                      FSM остаётся

"21:30" ─────────────────────────────► Нормализация: "21:30"
                                      UPDATE schedule_time = '21:30'

                                      "✅ Расписание изменено!"
```

### Сложность (кнопки)

```
[Пользователь]                        [Бот]

Кнопка "📊 Сложность" ───────────────► FSM: updating_bloom_level

                                      "📊 *Сейчас:* Понимание (2)"
                                      "Выберите уровень сложности:"

                                      [1️⃣ Знание]
                                      [2️⃣ Понимание]
                                      [3️⃣ Применение]

Кнопка "3️⃣ Применение" ─────────────► UPDATE complexity_level = 3
                                      UPDATE topics_at_current_complexity = 0

                                      "✅ Сложность изменена!"
```

**Важно:** При изменении сложности счётчик `topics_at_current_complexity` обнуляется.

### Дата старта марафона (кнопки)

```
[Пользователь]                        [Бот]

Кнопка "🗓 Дата старта" ─────────────► FSM: updating_marathon_start

                                      "🗓 *Сейчас:* 01.01.2026"
                                      "Когда начнём марафон?"

                                      [🚀 Сегодня]
                                      [📅 Завтра]
                                      [📅 Послезавтра]

Кнопка "📅 Завтра" ──────────────────► UPDATE marathon_start_date = today + 1

                                      "✅ Дата старта изменена!"
```

### Язык (кнопки)

```
[Пользователь]                        [Бот]

Кнопка "🌐 Language" ────────────────► Показ кнопок выбора

                                      [🇷🇺 Русский]
                                      [🇬🇧 English]
                                      [🇪🇸 Español]

Кнопка "🇬🇧 English" ────────────────► UPDATE language = 'en'

                                      "✅ Language changed!"
```

### Режим бота (переход)

```
[Пользователь]                        [Бот]

Кнопка "🤖 Режим бота" ──────────────► FSM: cleared
                                      Переход в /mode

                                      [Меню выбора режима]
```

### Отмена

```
[Пользователь]                        [Бот]

Кнопка "❌ Отмена" ──────────────────► FSM: cleared

                                      "👌 Отменено"
```

---

## 4. FSM состояния

```python
class UpdateStates(StatesGroup):
    choosing_field = State()           # Выбор поля
    updating_name = State()            # Ввод имени
    updating_occupation = State()      # Ввод занятия
    updating_interests = State()       # Ввод интересов
    updating_motivation = State()      # Ввод мотивации
    updating_goals = State()           # Ввод целей
    updating_duration = State()        # Выбор длительности
    updating_schedule = State()        # Ввод расписания
    updating_bloom_level = State()     # Выбор сложности
    updating_marathon_start = State()  # Выбор даты старта
```

---

## 5. Валидация ввода

### Текстовые поля

| Поле | Обработка |
|------|-----------|
| Имя, Занятие, Цели, Мотивация | `.strip()` |
| Интересы | Парсинг через `,` или `;`, `.strip()` каждого |

### Расписание

```python
try:
    h, m = map(int, text.strip().split(":"))
    if not (0 <= h <= 23 and 0 <= m <= 59):
        raise ValueError
    normalized = f"{h:02d}:{m:02d}"  # "9:5" → "09:05"
except:
    # Ошибка: повторный запрос
```

### Язык

```python
if new_lang not in ['ru', 'en', 'es']:
    new_lang = 'ru'  # fallback
```

---

## 6. Сохранение изменений

### Функция update_intern

```python
async def update_intern(chat_id: int, **kwargs):
    for key, value in kwargs.items():
        # JSON-поля кодируются
        if key in ['interests', 'completed_topics']:
            value = json.dumps(value)

        # Синхронизация complexity ↔ bloom
        if key == 'complexity_level':
            await conn.execute(
                'UPDATE interns SET complexity_level = $1, bloom_level = $1 WHERE chat_id = $2',
                value, chat_id
            )
            continue

        await conn.execute(
            f'UPDATE interns SET {key} = $1, updated_at = NOW() WHERE chat_id = $2',
            value, chat_id
        )
```

---

## 7. Константы

### Длительность сессии

```python
STUDY_DURATIONS = {
    "5": {"emoji": "⚡", "name": "5 минут", "words": 500},
    "15": {"emoji": "🕑", "name": "15 минут", "words": 1500},
    "25": {"emoji": "🕓", "name": "25 минут", "words": 2500}
}
```

### Уровни сложности

| Уровень | Название | Описание |
|---------|----------|----------|
| 1 | Знание | Понимание основ |
| 2 | Понимание | Применение на практике |
| 3 | Применение | Анализ и синтез |

### Поддерживаемые языки

```python
SUPPORTED_LANGUAGES = ['ru', 'en', 'es']
LANGUAGE_NAMES = {
    'ru': 'Русский',
    'en': 'English',
    'es': 'Español'
}
```

---

## 8. Ключевые файлы

| Файл | Строки | Назначение |
|------|--------|-----------|
| `bot.py` | 233-243 | FSM состояния |
| `bot.py` | 1917-1960 | Команда /update |
| `bot.py` | 1962-2280 | Хэндлеры обновления |
| `db/queries/users.py` | 163-189 | update_intern |
| `locales.py` | — | Локализация сообщений |

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-22 | Создание документа |
